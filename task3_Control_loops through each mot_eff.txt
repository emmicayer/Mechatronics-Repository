import pyb
from pyb import Timer, Pin
from motor import Motor
from encoder import Encoder

# TASK 3 - encoder, CLMC, motor
mot_left = Motor(Pin.cpu.B1, Pin.cpu.B14, Pin.cpu.B15, Timer(3, freq = 1000), 4)
mot_right = Motor(Pin.cpu.B0, Pin.cpu.C3, Pin.cpu.C2, Timer(3, freq = 1000), 3)
enc_left = Encoder(Timer(5, freq = 1000), Pin.cpu.A0, Pin.cpu.A1)
enc_right = Encoder(Timer(1, freq = 1000), Pin.cpu.A8, Pin.cpu.A9)

def run_L(shares):  
        s_mot_cmd, s_mot_eff_L,s_pos_L, s_vel_L, s_time_L = shares
        state_L = 1
        while True:
            if state_L == 1:                  # Motor off
                mot_left.set_effort(0)
                mot_left.disable()
                if s_mot_cmd.get() == 1.0:
                    state_L = 2
                yield 0
            elif state_L == 2:                # Motor on and set effort
                mot_left.enable()          # keep driver awake
                for i in range(11):
                    effort = i*10
                    s_mot_eff_L.put(effort)
                    mot_left.set_effort(effort)
                    enc_left.zero()
                    stepstart_L = pyb.millis()
                    for j in range(50):                   # waits for 1000 scheduler loops - change value to change wait time
                        enc_left.update()
                        pos_L = enc_left.get_position()
                        vel_L = enc_left.get_velocity()                # publish so DataCollect/plots can see motion
                        #print(pos_L)                                  # delete later?
                        elapsed_L = pyb.elapsed_millis(stepstart_L)
                        s_pos_L.put(pos_L)
                        s_vel_L.put(vel_L)
                        s_time_L.put(elapsed_L)
                        yield 0 
                    mot_left.set_effort(0)
                    for j in range(50):                   # waits for 1000 scheduler loops - change value to change wait time
                        yield 0                     
                s_mot_cmd.put(0.0)
                state_L = 1            

def run_R(shares):  
        s_mot_cmd, s_mot_eff_R,s_pos_R, s_vel_R, s_time_R = shares
        state_R = 1
        while True:
            if state_R == 1:                  # Motor off
                mot_right.set_effort(0)
                mot_right.disable()
                if s_mot_cmd.get() == 1.0:
                    state_R = 2
                yield 0
            elif state_R == 2:                # Motor on and set effort
                mot_right.enable()          # keep driver awake
      #          effort = s_mot_eff_R.get()
                for i in range(11):
                    effort = i*10
                    s_mot_eff_R.put(effort)
                    mot_right.set_effort(effort)
                    enc_right.zero() 
                    stepstart_R = pyb.millis()
                    for j in range(50):                   # waits for 1000 scheduler loops - change value to change wait time
                        enc_right.update()
                        pos_R = enc_right.get_position()
                        vel_R = enc_right.get_velocity()                # publish so DataCollect/plots can see motion
                        # print(pos_R)
                        elapsed_R = pyb.elapsed_millis(stepstart_R)
                        s_pos_R.put(pos_R)
                        s_vel_R.put(vel_R)
                        s_time_R.put(elapsed_R)
                        yield 0 
                    mot_right.set_effort(0)
                    for j in range(50):                   # waits for 1000 scheduler loops - change value to change wait time
                        yield 0                    
                s_mot_cmd.put(0.0)
                state_R = 1  